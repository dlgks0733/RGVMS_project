<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.rgvms.mapper.UserMapper">

	<select id="login" resultType="com.rgvms.domain.UserVO">

		SELECT USER_NO
			 , USER_PW
			 , USER_NAME
			 , REG_NUM
			 , STATE
			 , GRADE
			 , AUTHORITY
		FROM TBL_USER
		WHERE USER_NO = #{userNo}
		AND USER_PW = #{userPw}
	</select>
	
	<!-- 1. 사용자(학생) 등록(관리자) -->
	<insert id="insert">
		INSERT INTO
		TBL_USER(user_No, user_Name, reg_Num, state, grade)
		VALUES(#{userNo}, #{userName}, seq_reg.nextval, #{state}, #{grade})
	</insert>
	
	<!-- 2. 사용자(학생) 목록(관리자) -->
	<select id="list" resultType="com.rgvms.domain.UserVO">
		SELECT
		reg_num, user_No, grade, user_Name, state
		FROM
		TBL_USER
		WHERE authority = 0
		ORDER BY user_No DESC, grade DESC
	</select>
	
	<select id="read" resultType="com.rgvms.domain.UserVO">
		SELECT
		reg_num, user_No, grade, user_Name, state
		FROM
		TBL_USER
		WHERE user_No = #{userNo}
	</select>
	
	<!-- 3. 사용자(학생) 수정(관리자) -->
	<update id="update">
		UPDATE
		TBL_USER
		SET user_No = #{userNo}, grade = #{grade}, user_Name = #{userName},
			state = #{state}, user_Pw = #{userPw}, authority = #{authority},
			reg_num = #{regNum}
		WHERE user_No = #{userNo}
	</update>
	
	<!-- 4. 사용자(학생) 삭제(관리자) -->
	<delete id="delete">
		DELETE FROM TBL_USER
		WHERE user_No = #{userNo}
	</delete>
	
	<!-- 5. 검색 -->
	<!-- 인증항목 분류/영역/항목명/발행처로 키워드검색가능 -->
	<sql id="search">
		<if test="searchType != null">
				<if test="searchType == 'uno'.toString()">and user_No like '%' || #{keyword} || '%' </if>
				<if test="searchType == 'g'.toString()">and grade like '%' || #{keyword} || '%' </if>
				<if test="searchType == 'un'.toString()">and user_Name like '%' || #{keyword} || '%' </if>
				<if test="searchType == 's'.toString()">and state like '%' || #{keyword} || '%' </if>
		</if>
	</sql>
	
	<!-- 키워드로 검색된 리스트 목록 불러오기 -->
	<select id="listSearch" resultType="com.rgvms.domain.UserVO">
		<![CDATA[  
		SELECT
		*
		FROM(
			SELECT rownum rnum, user_No, grade, user_Name, state
			FROM (
				SELECT 
				user_No, grade, user_Name, state, authority
				FROM 
				TBL_USER
				WHERE user_No > 0 AND authority = 0
		]]>
		
		<!-- search에 대한 SQL문을 삽입 -->
		<include refid="search" />
				ORDER BY user_No DESC, grade DESC
			
		<![CDATA[    
				)) WHERE (rnum >= #{pageStart} AND rnum <= #{pageEnd}) 
			ORDER BY user_No DESC
		]]>
	</select>
	
	<!-- 페이징처리를 위한 검색된 리스트 목록의 ROW의 수 계산 -->
	<select id="listSearchCount" resultType="int">
		<![CDATA[  
		  SELECT
		  count(user_No) 
		  FROM
		  TBL_USER 
		  WHERE
		  user_No > 0 
		]]>
		<include refid="search" />
	</select>
	
	<!-- 6. 목록페이징처리 -->
	<select id="listCriteria" resultType="com.rgvms.domain.UserVO">
		<![CDATA[
			SELECT
			*
			FROM (
		 		SELECT 
		  		rownum rnum, user_No, grade, user_Name, state
		 		FROM 
		   		TBL_USER
		   		WHERE user_No > 0 ) 
		 	WHERE (rnum >= #{pageStart} AND rnum <= #{pageEnd}) 
		 	ORDER BY user_No DESC, grade DESC
		 ]]>
	</select>

	<select id="countPaging" resultType="int">
		<![CDATA[
			 SELECT 
			 count(user_No) 
			 FROM 
			 TBL_USER 
			 WHERE 
			 user_No > 0 
		]]>
	</select>
</mapper>
